# GUI приложение для генерации и постобработки изображений с помощью обученных моделей Diffusion-GAN

Графический интерфейс для генерации и постобработки изображений с использованием обученных моделей Diffusion GAN. Приложение предоставляет удобный способ генерации изображений и их последующей постобработки без необходимости использования командной строки.

## Содержание

- [Требования](#требования)
- [Установка](#установка)
- [Запуск](#запуск)
- [Описание интерфейса](#описание-интерфейса)
- [Параметры генерации](#параметры-генерации)
- [Параметры постобработки](#параметры-постобработки)
- [Порядок использования](#порядок-использования)
- [Структура проекта](#структура-проекта)

## Требования

### Системные требования

- Python 3.7 или выше
- PySide6 (Qt для Python)
- PyTorch
- CUDA (опционально, для использования GPU)
- X11 сервер (для работы через SSH)

### Зависимости Python

Основные зависимости:
- `PySide6` - графический интерфейс
- `torch` - глубокое обучение
- `numpy` - численные вычисления
- `PIL` (Pillow) - работа с изображениями
- `opencv-python` (cv2) - постобработка изображений

## Установка

### 1. Установка системных зависимостей (Linux)

Для работы GUI через X11 forwarding необходимо установить библиотеки X11:

```bash
sudo apt-get update
sudo apt-get install -y libxcb-cursor0 libxcb-xinerama0 libxcb-xfixes0 \
    libxkbcommon-x11-0 libxrender1 libfontconfig1 libxext6 libx11-6 \
    x11-utils libgl1-mesa-glx libglib2.0-0
```

### 2. Установка Python зависимостей

Если используется conda окружение:

```bash
conda activate pg  # или ваше имя окружения
conda install -c conda-forge pyside6
```

Или через pip:

```bash
pip install PySide6 opencv-python
```

### 3. Настройка X11 forwarding (для работы через SSH)

**На Windows:**
- Установите Xming или VcXsrv
- Запустите X сервер перед подключением по SSH
- Подключитесь с флагом `-X`: `ssh -X username@hostname`

**На Linux/Mac:**
- Обычно X сервер уже установлен
- Подключитесь с флагом `-X`: `ssh -X username@hostname`

## Запуск

### Способ 1: Через модуль Python (рекомендуется)

```bash
cd /path/to/diffusion-projected-gan
python -m gen_images_gui.app
```

### Способ 2: Напрямую через app.py

```bash
cd /path/to/diffusion-projected-gan
python gen_images_gui/app.py
```

### Способ 3: Импорт в Python скрипте

```python
from gen_images_gui import main
main()
```

## Описание интерфейса

Приложение состоит из вкладок и общих элементов интерфейса:

### Вкладки

Приложение имеет две вкладки для различных операций:

#### Вкладка "Генерация изображений"

Содержит все параметры для генерации изображений:
- **Network (--network)** - путь к файлу модели или URL
- **Seeds (--seeds)** - список seed'ов для генерации
- **Truncation Psi (--trunc)** - параметр усечения (по умолчанию: 1)
- **Class (--class)** - метка класса (опционально)
- **Noise Mode (--noise-mode)** - режим шума (const/random/none)
- **Translate (--translate)** - координаты переноса (по умолчанию: 0,0)
- **Rotate (--rotate)** - угол поворота в градусах (по умолчанию: 0)
- **Output Directory (--outdir)** - директория для сохранения изображений
- **Кнопка "Сгенерировать изображения"** - запускает процесс генерации

#### Вкладка "Постобработка"

Содержит параметры для постобработки сгенерированных изображений:
- **Директория с изображениями** - путь к папке с изображениями для обработки
- **Strength (сила маскирования)** - сила нерезкого маскирования (по умолчанию: 0.8)
- **Kernel Size Gauss (размер ядра Гаусса)** - размер ядра фильтра Гаусса (по умолчанию: 3,3)
- **Kernel Size Median (размер ядра медианного)** - размер ядра медианного фильтра (по умолчанию: 3)
- **Сохранять цвета** - чекбокс для сохранения цветов изображения (по умолчанию: включен)
- **Кнопка "Выполнить постобработку"** - запускает процесс постобработки

### Общие элементы интерфейса

#### Окно предпросмотра (середина)

Отображает сгенерированные или обработанные изображения:
- После завершения генерации всех изображений автоматически показывается первое изображение
- После завершения постобработки автоматически показывается первое обработанное изображение

#### Навигация по изображениям

Кнопки для переключения между изображениями:
- **◀ Предыдущее** - показать предыдущее изображение
- **Следующее ▶** - показать следующее изображение
- Счетчик показывает текущее изображение и общее количество

#### Окно логирования (нижняя часть)

Отображает информацию о процессах:
- Загрузка модели
- Прогресс генерации каждого изображения
- Прогресс постобработки каждого изображения
- Сообщения об ошибках
- Статистика загруженных и обработанных изображений

## Параметры генерации

### Network (--network)

**Обязательный параметр**

Путь к файлу предобученной модели (`.pkl`) или URL для загрузки модели.

**Примеры:**
- Локальный файл: `/path/to/model.pkl`
- URL: `https://api.ngc.nvidia.com/v2/models/nvidia/research/stylegan3/versions/1/files/stylegan3-r-afhqv2-512x512.pkl`

### Seeds (--seeds)

**Обязательный параметр**

Список случайных seed'ов для генерации. Можно указать отдельные числа или диапазоны.

**Формат:**
- Отдельные числа: `0,1,5`
- Диапазоны: `0-10` (генерирует числа от 0 до 10 включительно)
- Комбинация: `0,1,5-10,20` (генерирует: 0, 1, 5, 6, 7, 8, 9, 10, 20)

**Примеры:**
- `0` - одно изображение
- `0,1,2` - три изображения
- `0-9` - десять изображений (0, 1, 2, ..., 9)
- `1000-1999` - тысяча изображений

### Truncation Psi (--trunc)

**По умолчанию: 1**

Параметр усечения, контролирующий разнообразие генерируемых изображений:
- `1.0` - максимальное разнообразие
- `0.7` - более консервативная генерация
- Меньшие значения дают более предсказуемые результаты

### Class (--class)

**Опциональный параметр**

Метка класса для условных моделей. Требуется только для условных сетей.

**Пример:** `0`, `1`, `2` и т.д.

### Noise Mode (--noise-mode)

**По умолчанию: const**

Режим генерации шума:
- `const` - постоянный шум
- `random` - случайный шум
- `none` - без шума

### Translate (--translate)

**По умолчанию: 0,0**

Координаты переноса изображения в формате `x,y`.

**Примеры:**
- `0,0` - без переноса
- `0.3,1` - перенос по X на 0.3, по Y на 1

### Rotate (--rotate)

**По умолчанию: 0**

Угол поворота изображения в градусах.

**Примеры:**
- `0` - без поворота
- `90` - поворот на 90 градусов
- `-45` - поворот на -45 градусов

### Output Directory (--outdir)

**По умолчанию: out**

Директория для сохранения сгенерированных изображений. Если директория не существует, она будет создана автоматически.

## Параметры постобработки

### Директория с изображениями

**Обязательный параметр**

Путь к директории, содержащей изображения для постобработки. После генерации это поле автоматически заполняется значением из поля "Output Directory" вкладки генерации.

**Пример:** `out`, `/path/to/images`

### Strength (сила маскирования)

**По умолчанию: 0.8**

Величина "силы" нерезкого маскирования. Контролирует интенсивность эффекта повышения резкости:
- `0.8` - стандартное значение
- Большие значения (до 1.5) - более сильный эффект
- Меньшие значения (0.1-0.5) - более мягкий эффект

### Kernel Size Gauss (размер ядра Гаусса)

**По умолчанию: 3,3**

Размерность ядра фильтра Гаусса в формате `width,height`. Должно быть нечетным числом.

**Примеры:**
- `3,3` - стандартное значение
- `5,5` - более сильное размытие
- `1,1` - минимальное размытие

### Kernel Size Median (размер ядра медианного)

**По умолчанию: 3**

Размерность ядра медианного фильтра. Должно быть нечетным числом (3, 5, 7, и т.д.).

**Примеры:**
- `3` - стандартное значение
- `5` - более сильная фильтрация
- `7` - очень сильная фильтрация

### Сохранять цвета

**По умолчанию: включено**

Если включено, изображение обрабатывается в цветном режиме. Если выключено, изображение преобразуется в оттенки серого перед обработкой.

## Порядок использования

### Шаг 1: Генерация изображений

1. Перейдите на вкладку **"Генерация изображений"**
2. Заполните все необходимые параметры:
   - Укажите путь к модели в поле **Network**
   - Укажите seed'ы для генерации в поле **Seeds** (например, `0-999` для 1000 изображений)
   - Настройте остальные параметры по необходимости
   - Укажите выходную директорию в поле **Output Directory**
3. Нажмите кнопку **"Сгенерировать изображения"**
4. Дождитесь завершения генерации всех изображений
5. После завершения в окне предпросмотра автоматически появится первое сгенерированное изображение

### Шаг 2: Постобработка изображений

1. Перейдите на вкладку **"Постобработка"**
2. Поле **"Директория с изображениями"** автоматически заполнено значением из генерации
3. Настройте параметры постобработки:
   - **Strength** - сила маскирования (по умолчанию: 0.8)
   - **Kernel Size Gauss** - размер ядра Гаусса (по умолчанию: 3,3)
   - **Kernel Size Median** - размер ядра медианного (по умолчанию: 3)
   - **Сохранять цвета** - включено по умолчанию
4. Нажмите кнопку **"Выполнить постобработку"**
5. Дождитесь завершения обработки всех изображений
6. После завершения изображения будут перезаписаны в той же директории
7. В окне предпросмотра автоматически появится первое обработанное изображение

### Важные замечания

- **Изображения перезаписываются**: После постобработки исходные изображения заменяются обработанными версиями
- **Рекомендуется**: Сделать резервную копию изображений перед постобработкой, если нужны оригиналы
- **Последовательность**: Сначала выполните генерацию, затем постобработку
- **Директория**: После генерации директория автоматически устанавливается в поле постобработки для удобства

## Структура проекта

```
gen_images_gui/
├── __init__.py                    # Экспорт основных классов
├── app.py                         # Точка входа приложения
├── main_window.py                 # Главное окно GUI с вкладками
├── utils.py                       # Утилиты для парсинга параметров
├── threads/
│   ├── __init__.py
│   ├── generation_worker.py      # Рабочий поток генерации
│   └── postprocessing_worker.py   # Рабочий поток постобработки
└── README.md                      # Документация
```

### Основные компоненты

- **`app.py`** - точка входа, запускает GUI приложение
- **`main_window.py`** - реализация главного окна с вкладками генерации и постобработки
- **`utils.py`** - вспомогательные функции для парсинга параметров
- **`threads/generation_worker.py`** - класс для генерации изображений в отдельном потоке
- **`threads/postprocessing_worker.py`** - класс для постобработки изображений в отдельном потоке

### Алгоритм постобработки

Постобработка выполняется по следующему алгоритму:
1. Применение первого шага нерезкого маскирования (Gaussian blur)
2. Применение второго шага нерезкого маскирования (addWeighted)
3. Применение фильтра увеличения резкости с ядром K
4. Применение гауссова размытия с указанным размером ядра
5. Применение медианного размытия с указанным размером ядра

Результат сохраняется в том же файле, перезаписывая исходное изображение.